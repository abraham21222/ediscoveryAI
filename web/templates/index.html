<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI E-Discovery Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }

        .stat-card.ai-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* AI Processing Panel */
        .ai-processing-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .ai-processing-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .ai-processing-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .ai-processing-stat {
            font-size: 14px;
            opacity: 0.9;
        }

        .ai-processing-stat strong {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        .ai-processing-actions {
            display: flex;
            gap: 10px;
        }

        .ai-button {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .ai-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-progress {
            margin-top: 15px;
            display: none;
        }

        .ai-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .ai-progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }

        .ai-progress-text {
            margin-top: 8px;
            font-size: 13px;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"], input[type="date"], select {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .relevance-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e8ed;
            outline: none;
            -webkit-appearance: none;
        }

        .relevance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .results {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .results-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .results-controls select {
            padding: 8px 12px;
            font-size: 14px;
        }

        .export-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            padding: 10px 20px;
            font-size: 14px;
        }

        .document-card {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .document-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .document-card.hot {
            border-color: #f5576c;
            background: #fff5f7;
        }

        .document-card.privileged {
            border-color: #ffa500;
            background: #fff8f0;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .document-subject {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .document-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
        }

        .document-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.source {
            background: #667eea;
            color: white;
        }

        .badge.hot {
            background: #f5576c;
            color: white;
        }

        .badge.relevant {
            background: #4CAF50;
            color: white;
        }

        .badge.routine {
            background: #9E9E9E;
            color: white;
        }

        .badge.privileged {
            background: #ffa500;
            color: white;
        }

        .badge.pending {
            background: #e1e8ed;
            color: #666;
        }

        .ai-score {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
        }

        .score-bar {
            flex: 1;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #FFC107 50%, #f5576c 100%);
            transition: width 0.3s;
        }

        .score-value {
            font-weight: 600;
            color: #667eea;
        }

        .ai-summary {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e8ed;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 900px;
            margin: 40px auto;
            border-radius: 16px;
            padding: 30px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .ai-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .ai-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .ai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ai-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ai-metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .ai-metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .topics-list, .action-items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .topic-tag {
            background: #e7f0ff;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI E-Discovery Platform</h1>
            <p class="subtitle">Powered by Claude AI ‚Ä¢ PostgreSQL Full-Text Search ‚Ä¢ AWS S3</p>
            
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-documents">-</div>
                    <div class="stat-label">Total Documents</div>
                </div>
                <div class="stat-card ai-card">
                    <div class="stat-value" id="stat-analyzed">-</div>
                    <div class="stat-label">AI Analyzed</div>
                </div>
                <div class="stat-card ai-card">
                    <div class="stat-value" id="stat-pending">-</div>
                    <div class="stat-label">Pending Analysis</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-hot">-</div>
                    <div class="stat-label">Hot Documents</div>
                </div>
            </div>
        </div>

        <!-- AI Processing Panel -->
        <div class="ai-processing-panel" id="aiProcessingPanel" style="display: none;">
            <h2>ü§ñ AI Document Analysis</h2>
            <div class="ai-processing-info">
                <div class="ai-processing-stat">
                    <strong id="pendingCount">0</strong>
                    Documents pending analysis
                </div>
                <div class="ai-processing-stat">
                    <strong id="estimatedCost">$0.00</strong>
                    Estimated cost
                </div>
                <div class="ai-processing-actions">
                    <button class="ai-button" onclick="startAIProcessing()" id="analyzeButton">
                        üöÄ Analyze Documents
                    </button>
                </div>
            </div>
            <div class="ai-progress" id="aiProgress">
                <div class="ai-progress-bar">
                    <div class="ai-progress-fill" id="aiProgressFill"></div>
                </div>
                <div class="ai-progress-text" id="aiProgressText"></div>
            </div>
        </div>

        <div class="search-box">
            <div class="search-input-group">
                <input type="text" id="searchQuery" placeholder="üîç Search documents... (e.g., 'quarterly report', 'contract', or leave empty for all)" />
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Custodian</label>
                    <input type="text" id="searchCustodian" placeholder="user@example.com" />
                </div>
                
                <div class="filter-group">
                    <label>AI Classification</label>
                    <select id="searchClassification">
                        <option value="">All Classifications</option>
                        <option value="Hot Document">üî• Hot Document</option>
                        <option value="Relevant">‚úì Relevant</option>
                        <option value="Routine">‚óã Routine</option>
                        <option value="Privileged">‚öñÔ∏è Privileged</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Min Relevance: <span id="relevanceValue">0</span></label>
                    <input type="range" id="searchRelevance" class="relevance-slider" min="0" max="100" value="0" />
                </div>
                
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="searchDateFrom" />
                </div>
                
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="searchDateTo" />
                </div>
            </div>
            
            <button onclick="performSearch()" id="searchButton">
                üîç Search Documents
            </button>
        </div>

        <div class="results">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Loading documents...</div>
                <div class="results-controls">
                    <label for="sortBy" style="font-size: 14px; color: #666;">Sort by:</label>
                    <select id="sortBy" onchange="applySorting()">
                        <option value="relevance">AI Relevance</option>
                        <option value="date_desc">Date (Newest)</option>
                        <option value="date_asc">Date (Oldest)</option>
                        <option value="custodian">Custodian</option>
                        <option value="classification">Classification</option>
                    </select>
                    <button class="export-button" onclick="exportResults()" id="exportButton">
                        üìä Export to CSV
                    </button>
                </div>
            </div>
            <div id="resultsContainer">
                <div class="loading">Loading documents...</div>
            </div>
        </div>
    </div>

    <!-- Document Details Modal -->
    <div class="modal" id="documentModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let currentDocuments = [];
        let currentSort = 'relevance';

        // Load statistics and perform initial search on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadAIStats();
            performSearch(); // Automatically load all documents
        });

        // Update relevance slider value display
        document.getElementById('searchRelevance').addEventListener('input', function(e) {
            document.getElementById('relevanceValue').textContent = e.target.value;
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-documents').textContent = data.stats.total_documents.toLocaleString();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadAIStats() {
            try {
                const response = await fetch('/api/ai-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stat-analyzed').textContent = stats.analyzed_documents.toLocaleString();
                    document.getElementById('stat-pending').textContent = stats.pending_documents.toLocaleString();
                    document.getElementById('stat-hot').textContent = stats.high_priority_count.toLocaleString();
                    
                    // Show AI processing panel if there are pending documents
                    if (stats.pending_documents > 0) {
                        document.getElementById('aiProcessingPanel').style.display = 'block';
                        document.getElementById('pendingCount').textContent = stats.pending_documents;
                        const estimatedCost = (stats.pending_documents * 0.10).toFixed(2);
                        document.getElementById('estimatedCost').textContent = `$${estimatedCost}`;
                    } else {
                        document.getElementById('aiProcessingPanel').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        }

        async function startAIProcessing() {
            const button = document.getElementById('analyzeButton');
            const progress = document.getElementById('aiProgress');
            const progressFill = document.getElementById('aiProgressFill');
            const progressText = document.getElementById('aiProgressText');
            
            if (!confirm('This will analyze all pending documents using AI. This may take several minutes and incur API costs. Continue?')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ Starting...';
            progress.style.display = 'block';
            
            progressText.textContent = 'üöÄ Starting AI analysis worker...';
            progressFill.style.width = '10%';
            
            // Poll for progress
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/ai-stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        const total = parseInt(document.getElementById('pendingCount').textContent);
                        const remaining = data.stats.pending_documents;
                        const processed = total - remaining;
                        const percentComplete = Math.round((processed / total) * 100);
                        
                        progressFill.style.width = `${Math.max(10, percentComplete)}%`;
                        progressText.textContent = `üìä Processed ${processed}/${total} documents (${percentComplete}%)`;
                        
                        // Update stats
                        document.getElementById('stat-analyzed').textContent = data.stats.analyzed_documents.toLocaleString();
                        document.getElementById('stat-pending').textContent = data.stats.pending_documents.toLocaleString();
                        document.getElementById('stat-hot').textContent = data.stats.high_priority_count.toLocaleString();
                        
                        if (remaining === 0) {
                            clearInterval(pollInterval);
                            progress.style.display = 'none';
                            button.disabled = false;
                            button.textContent = '‚úÖ Analysis Complete!';
                            document.getElementById('aiProcessingPanel').style.display = 'none';
                            
                            // Refresh results
                            performSearch();
                            
                            setTimeout(() => {
                                button.textContent = 'üöÄ Analyze Documents';
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll AI progress:', error);
                }
            }, 3000);
            
            // Trigger AI processing (you'll need to add an endpoint for this)
            // For now, user needs to run: python3 scripts/ai_worker.py --once --batch-size 10
            alert('To process documents, please run in terminal:\n\npython3 scripts/ai_worker.py --loop --batch-size 5\n\nThis window will show progress automatically.');
        }

        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const custodian = document.getElementById('searchCustodian').value.trim();
            const classification = document.getElementById('searchClassification').value;
            const minRelevance = document.getElementById('searchRelevance').value;
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            
            const searchButton = document.getElementById('searchButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            // Show loading
            searchButton.disabled = true;
            searchButton.textContent = '‚è≥ Searching...';
            resultsContainer.innerHTML = '<div class="loading">Searching documents...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        custodian,
                        classification,
                        min_relevance: minRelevance,
                        date_from: dateFrom,
                        date_to: dateTo,
                        limit: 100
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentDocuments = data.documents;
                    applySorting();
                    resultsCount.textContent = `Found ${data.count} document(s)`;
                } else {
                    resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon">‚ùå</div><p>Error: ${data.error}</p></div>`;
                    resultsCount.textContent = 'Search failed';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon">‚ùå</div><p>Error: ${error.message}</p></div>`;
                resultsCount.textContent = 'Search failed';
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'üîç Search Documents';
            }
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            const sorted = [...currentDocuments];
            
            switch(sortBy) {
                case 'relevance':
                    sorted.sort((a, b) => (b.ai_relevance || 0) - (a.ai_relevance || 0));
                    break;
                case 'date_desc':
                    sorted.sort((a, b) => new Date(b.collected_at) - new Date(a.collected_at));
                    break;
                case 'date_asc':
                    sorted.sort((a, b) => new Date(a.collected_at) - new Date(b.collected_at));
                    break;
                case 'custodian':
                    sorted.sort((a, b) => (a.custodian_email || '').localeCompare(b.custodian_email || ''));
                    break;
                case 'classification':
                    const classOrder = {'Hot Document': 0, 'Privileged': 1, 'Relevant': 2, 'Routine': 3, 'Pending': 4};
                    sorted.sort((a, b) => {
                        const aClass = classOrder[a.ai_classification] ?? 4;
                        const bClass = classOrder[b.ai_classification] ?? 4;
                        return aClass - bClass;
                    });
                    break;
            }
            
            displayResults(sorted);
        }

        function displayResults(documents) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (documents.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <p>No documents found matching your search</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = documents.map(doc => {
                const classification = doc.ai_classification || 'Pending';
                const relevance = doc.ai_relevance || 0;
                const cardClass = classification === 'Hot Document' ? 'hot' : 
                                classification === 'Privileged' ? 'privileged' : '';
                
                return `
                    <div class="document-card ${cardClass}" onclick="viewDocument('${doc.document_id}')">
                        <div class="document-header">
                            <div style="flex: 1;">
                                <div class="document-subject">${escapeHtml(doc.subject || 'No Subject')}</div>
                                <div class="document-meta">
                                    <strong>From:</strong> ${escapeHtml(doc.custodian_email || 'Unknown')}
                                </div>
                                <div class="document-meta">
                                    <strong>Date:</strong> ${formatDate(doc.collected_at)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="document-badges">
                            <span class="badge source">${escapeHtml(doc.source)}</span>
                            ${classification !== 'Pending' ? `
                                <span class="badge ${classification.toLowerCase().replace(' ', '-')}">
                                    ${classification}
                                </span>
                            ` : '<span class="badge pending">‚è≥ AI Pending</span>'}
                        </div>
                        
                        ${classification !== 'Pending' ? `
                            <div class="ai-score">
                                <span>AI Relevance:</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${relevance}%"></div>
                                </div>
                                <span class="score-value">${relevance}/100</span>
                            </div>
                        ` : ''}
                        
                        ${doc.ai_summary ? `
                            <div class="ai-summary">
                                üí° ${escapeHtml(doc.ai_summary)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function viewDocument(documentId) {
            const modal = document.getElementById('documentModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = '<div class="loading">Loading document...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`/api/document/${documentId}`);
                const data = await response.json();
                
                if (data.success) {
                    const doc = data.document;
                    const hasAI = doc.ai_analyzed_at !== null;
                    
                    modalContent.innerHTML = `
                        <h2>${escapeHtml(doc.subject || 'No Subject')}</h2>
                        <div class="document-meta" style="margin-top: 10px;">
                            <strong>Document ID:</strong> ${escapeHtml(doc.document_id)}<br>
                            <strong>From:</strong> ${escapeHtml(doc.custodian_email || 'Unknown')}<br>
                            <strong>Date:</strong> ${formatDate(doc.collected_at)}<br>
                            <strong>Source:</strong> ${escapeHtml(doc.source)}
                        </div>
                        
                        ${hasAI ? `
                            <div class="ai-section">
                                <h3>ü§ñ AI Analysis Results</h3>
                                <div class="ai-grid">
                                    <div class="ai-metric">
                                        <div class="ai-metric-label">Classification</div>
                                        <div class="ai-metric-value">${doc.ai_classification}</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-label">Relevance Score</div>
                                        <div class="ai-metric-value">${doc.ai_relevance}/100</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-label">Privilege Risk</div>
                                        <div class="ai-metric-value">${doc.ai_privilege_risk}/100</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-label">Analyzed</div>
                                        <div class="ai-metric-value" style="font-size: 14px;">${formatDate(doc.ai_analyzed_at)}</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <strong>üìù AI Summary:</strong>
                                    <p style="margin-top: 10px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px;">
                                        ${escapeHtml(doc.ai_summary || 'N/A')}
                                    </p>
                                </div>
                                
                                ${doc.ai_review_notes ? `
                                    <div style="margin-top: 15px;">
                                        <strong>‚öñÔ∏è Attorney Review Notes:</strong>
                                        <p style="margin-top: 10px; line-height: 1.6; background: #fff3cd; padding: 15px; border-radius: 8px;">
                                            ${escapeHtml(doc.ai_review_notes)}
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${doc.ai_topics && doc.ai_topics.length > 0 ? `
                                    <div style="margin-top: 15px;">
                                        <strong>üè∑Ô∏è Key Topics:</strong>
                                        <div class="topics-list">
                                            ${doc.ai_topics.map(topic => `
                                                <span class="topic-tag">${escapeHtml(topic)}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${doc.ai_action_items && doc.ai_action_items.length > 0 ? `
                                    <div style="margin-top: 15px;">
                                        <strong>‚úÖ Action Items:</strong>
                                        <div class="topics-list">
                                            ${doc.ai_action_items.map(item => `
                                                <span class="topic-tag">‚Ä¢ ${escapeHtml(item)}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : '<div class="ai-section"><p>‚è≥ AI analysis pending for this document...</p></div>'}
                        
                        <div style="margin-top: 20px;">
                            <h3>üìÑ Document Content</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto; margin-top: 10px; border: 1px solid #e1e8ed;">
                                ${escapeHtml(doc.body_text || 'No body text')}
                            </div>
                        </div>
                    `;
                } else {
                    modalContent.innerHTML = `<p>Error loading document: ${data.error}</p>`;
                }
            } catch (error) {
                modalContent.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        function exportResults() {
            if (currentDocuments.length === 0) {
                alert('No documents to export. Please perform a search first.');
                return;
            }
            
            // Create CSV content
            const headers = ['Document ID', 'Subject', 'Custodian Email', 'Date', 'Source', 'AI Classification', 'AI Relevance', 'AI Privilege Risk', 'AI Summary', 'AI Topics'];
            const rows = currentDocuments.map(doc => [
                doc.document_id,
                doc.subject || '',
                doc.custodian_email || '',
                doc.collected_at,
                doc.source,
                doc.ai_classification || 'Pending',
                doc.ai_relevance || '',
                doc.ai_privilege_risk || '',
                (doc.ai_summary || '').replace(/"/g, '""'),
                (doc.ai_topics || []).join('; ')
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ediscovery_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closeModal() {
            document.getElementById('documentModal').style.display = 'none';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Allow Enter key to search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('documentModal');
            if (e.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>
