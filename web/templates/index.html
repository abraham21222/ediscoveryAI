<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI E-Discovery Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }

        .stat-card.ai-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Tag styles */
        .tag {
            display: inline-block;
            background: #e7f0ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag:hover {
            background: #667eea;
            color: white;
        }

        .tag.user-tag {
            background: #fff3cd;
            color: #856404;
        }

        .tag.removable {
            padding-right: 24px;
            position: relative;
        }

        .tag.removable::after {
            content: '√ó';
            position: absolute;
            right: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .tag-input {
            display: inline-flex;
            gap: 5px;
            align-items: center;
            margin-top: 10px;
        }

        .tag-input input {
            padding: 6px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 13px;
        }

        .tag-input button {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Review panel styles */
        .review-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e1e8ed;
        }

        .review-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-panel h3::before {
            content: 'üë§';
            font-size: 20px;
        }

        .review-section {
            margin-bottom: 15px;
        }

        .review-section label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .review-section select,
        .review-section textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .review-section textarea {
            min-height: 80px;
            resize: vertical;
        }

        .relevance-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .relevance-input input[type="range"] {
            flex: 1;
        }

        .relevance-input .value {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
        }

        .review-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .review-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .review-checkbox label {
            cursor: pointer;
            margin: 0;
            text-transform: none;
            font-size: 14px;
        }

        .save-review-btn {
            width: 100%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            margin-top: 10px;
        }

        /* Document card enhancements */
        .document-card {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .document-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .document-card.hot {
            border-color: #f5576c;
            background: #fff5f7;
        }

        .document-card.privileged {
            border-color: #ffa500;
            background: #fff8f0;
        }

        .document-card.user-critical {
            border-color: #dc3545;
            background: #fff0f0;
            border-width: 3px;
        }

        .document-card.reviewed {
            opacity: 0.8;
        }

        .document-card.reviewed::after {
            content: '‚úì Reviewed';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .document-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .document-card:hover .document-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #667eea;
            color: white;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-btn.tag-btn {
            background: #ffc107;
            color: #333;
        }

        .action-btn.review-btn {
            background: #28a745;
        }

        .classifications {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .classification-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .classification-badge.ai {
            background: #e7f0ff;
            color: #667eea;
        }

        .classification-badge.user {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"], input[type="date"], select {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .results-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            padding: 10px 20px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 900px;
            margin: 40px auto;
            border-radius: 16px;
            padding: 30px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Quick tag menu */
        .quick-tag-menu {
            position: absolute;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 100;
            min-width: 200px;
        }

        .quick-tag-menu h4 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 14px;
        }

        .quick-tag-option {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .quick-tag-option:hover {
            background: #f0f0f0;
        }

        .relevance-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e1e8ed;
            outline: none;
            -webkit-appearance: none;
        }

        .relevance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
    </style>
    <script src="/static/delete_functions.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h1>ü§ñ AI E-Discovery Platform</h1>
                    <p class="subtitle">User-Driven Document Review ‚Ä¢ Powered by Claude AI & Semantic Search</p>
                </div>
                <div style="text-align: right; display: flex; gap: 15px; align-items: start;">
                    <div id="costTracker" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px 20px; border-radius: 12px; min-width: 180px; cursor: pointer;" onclick="showCostBreakdown()">
                        <div style="font-size: 12px; opacity: 0.9; text-transform: uppercase; font-weight: 600;">Total Cost</div>
                        <div id="totalCost" style="font-size: 32px; font-weight: bold; margin: 5px 0;">$0.00</div>
                        <div style="font-size: 11px; opacity: 0.8;">üí° Click for breakdown</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button id="deleteSelectedBtn" onclick="deleteSelectedDocuments()" style="background: #f59e0b; color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: none; transition: all 0.3s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                            üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="confirmDeleteAll()" style="background: #dc3545; color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            üóëÔ∏è Remove All Documents
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Bar -->
            <div style="background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <a href="/relativity" style="color: #667eea; text-decoration: none; font-weight: 600; padding: 8px 16px; border-radius: 8px; background: #eef1ff; display: inline-block; transition: all 0.3s;">
                    ‚öñÔ∏è Relativity Integration
                </a>
                <span style="color: #9ca3af; margin: 0 15px;">|</span>
                <a href="/" style="color: #6b7280; text-decoration: none; font-weight: 600; padding: 8px 16px;">
                    üè† Search Dashboard
                </a>
            </div>
            
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-documents">-</div>
                    <div class="stat-label">Total Documents</div>
                </div>
                <div class="stat-card ai-card">
                    <div class="stat-value" id="stat-analyzed">-</div>
                    <div class="stat-label">AI Analyzed</div>
                </div>
                <div class="stat-card ai-card">
                    <div class="stat-value" id="stat-pending">-</div>
                    <div class="stat-label">Pending Analysis</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-hot">-</div>
                    <div class="stat-label">Hot Documents</div>
                </div>
            </div>
        </div>

        <div class="search-box">
            <div class="search-input-group">
                <input type="text" id="searchQuery" placeholder="üîç Search documents... (e.g., 'quarterly report', 'contract', or leave empty for all)" />
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Custodian</label>
                    <input type="text" id="searchCustodian" placeholder="user@example.com" />
                </div>
                
                <div class="filter-group">
                    <label>AI Classification</label>
                    <select id="searchClassification">
                        <option value="">All Classifications</option>
                        <option value="Hot Document">üî• Hot Document</option>
                        <option value="Relevant">‚úì Relevant</option>
                        <option value="Routine">‚óã Routine</option>
                        <option value="Privileged">‚öñÔ∏è Privileged</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Your Tags</label>
                    <select id="searchTag">
                        <option value="">All Tags</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Review Status</label>
                    <select id="searchReviewStatus">
                        <option value="">All Documents</option>
                        <option value="reviewed">‚úì Reviewed Only</option>
                        <option value="unreviewed">‚è≥ Unreviewed Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="searchDateFrom" />
                </div>
                
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="searchDateTo" />
                </div>
                
                <div class="filter-group">
                    <label>üìÅ File Type</label>
                    <select id="searchFileCategory">
                        <option value="">All File Types</option>
                        <option value="email">üìß Email</option>
                        <option value="document">üìÑ Document</option>
                        <option value="spreadsheet">üìä Spreadsheet</option>
                        <option value="presentation">üìΩÔ∏è Presentation</option>
                        <option value="image">üñºÔ∏è Image</option>
                        <option value="video">üé• Video</option>
                        <option value="audio">üéµ Audio</option>
                        <option value="archive">üì¶ Archive</option>
                        <option value="database">üíæ Database</option>
                        <option value="code">üíª Code</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>‚ö†Ô∏è Data Quality</label>
                    <select id="searchDataQuality">
                        <option value="">All Quality</option>
                        <option value="valid">‚úì Valid</option>
                        <option value="corrupted">‚ö†Ô∏è Corrupted</option>
                        <option value="encrypted">üîí Encrypted</option>
                        <option value="truncated">‚úÇÔ∏è Truncated</option>
                        <option value="invalid_format">‚ùå Invalid Format</option>
                        <option value="suspicious">ü¶† Suspicious</option>
                    </select>
                </div>
            </div>
            
            <button onclick="performSearch()" id="searchButton">
                üîç Search Documents
            </button>
        </div>

        <div class="results">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Loading documents...</div>
                <div class="results-controls">
                    <label for="sortBy" style="font-size: 14px; color: #666;">Sort by:</label>
                    <select id="sortBy" onchange="applySorting()">
                        <option value="user_relevance">üë§ Your Relevance</option>
                        <option value="ai_relevance">ü§ñ AI Relevance</option>
                        <option value="date_desc">üìÖ Date (Newest)</option>
                        <option value="date_asc">üìÖ Date (Oldest)</option>
                        <option value="custodian">üë• Custodian</option>
                    </select>
                    <button onclick="showCustomAIPanel()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 10px 20px; font-size: 14px; margin: 0 10px;">
                        üéØ Custom AI Analysis
                    </button>
                    <button class="export-button" onclick="exportResults()" id="exportButton">
                        üìä Export to CSV
                    </button>
                </div>
            </div>
            <div id="resultsContainer">
                <div class="loading">Loading documents...</div>
            </div>
        </div>
    </div>

    <!-- Document Details Modal -->
    <div class="modal" id="documentModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Quick Tag Menu -->
    <div id="quickTagMenu" class="quick-tag-menu" style="display: none;">
        <h4>Add Tag</h4>
        <div class="quick-tag-option" onclick="quickTag('Important')">‚≠ê Important</div>
        <div class="quick-tag-option" onclick="quickTag('Follow-up')">üìå Follow-up</div>
        <div class="quick-tag-option" onclick="quickTag('Legal Review')">‚öñÔ∏è Legal Review</div>
        <div class="quick-tag-option" onclick="quickTag('Privileged')">üîí Privileged</div>
        <div class="quick-tag-option" onclick="quickTag('Hot')">üî• Hot</div>
        <div class="quick-tag-option" onclick="quickTag('Not Relevant')">‚ùå Not Relevant</div>
        <hr style="margin: 10px 0;">
        <input type="text" id="customTagInput" placeholder="Custom tag..." 
               onkeypress="if(event.key==='Enter') quickTag(document.getElementById('customTagInput').value)"
               style="width: 100%; padding: 8px; border: 1px solid #e1e8ed; border-radius: 6px;">
    </div>

    <!-- Cost Breakdown Modal -->
    <div class="modal" id="costModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCostModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üí∞ Cost Breakdown</h2>
            <div id="costBreakdownContent"></div>
        </div>
    </div>

    <!-- Results Summary Modal -->
    <div class="modal" id="resultsSummaryModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="closeResultsSummary()">&times;</span>
            <h2 style="margin-bottom: 20px;">üéâ Custom AI Analysis Complete!</h2>
            
            <div id="resultsSummaryContent"></div>
            
            <div style="margin-top: 30px; text-align: right;">
                <button onclick="closeResultsSummary()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;">
                    Got It!
                </button>
            </div>
        </div>
    </div>
    
    <!-- Redacted Documents Modal -->
    <div class="modal" id="redactedDocsModal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="closeRedactedDocs()">&times;</span>
            <h2 style="margin-bottom: 20px;">üîí Redacted Documents</h2>
            
            <div id="redactedDocsContent"></div>
            
            <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                <button onclick="exportRedactedDocs()" style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;">
                    üì• Export All Redacted
                </button>
                <button onclick="closeRedactedDocs()" style="background: #667eea; color: white; padding: 12px 30px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Custom AI Analysis Modal -->
    <div class="modal" id="customAIModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCustomAIModal()">&times;</span>
            <h2 style="color: #f5576c; margin-bottom: 20px;">üéØ Custom AI Analysis</h2>
            <div id="customAIContent">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FFC107;">
                    <strong>üí° What is this?</strong>
                    <p style="margin-top: 8px; font-size: 14px; line-height: 1.6;">
                        Direct the AI to re-analyze your <strong>currently filtered documents</strong> with a custom instruction.
                        Perfect for targeted searches like "find attorney-client communications" or "identify financial fraud indicators".
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìä Current Selection</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #667eea;" id="customAIDocCount">0</div>
                            <div style="font-size: 13px; color: #666;">Documents Selected</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #FF9800;" id="customAICost">$0.00</div>
                            <div style="font-size: 13px; color: #666;">Estimated Cost</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                        üéØ What should the AI look for?
                    </label>
                    <textarea id="customAIPrompt" 
                              placeholder="Example: Analyze these documents for attorney-client privilege. Look for communications between lawyers and clients, legal advice, and privileged information. Flag any documents that may be privileged."
                              style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; font-family: inherit; line-height: 1.6;"></textarea>
                    <div style="margin-top: 10px; font-size: 13px; color: #666;">
                        üí° <strong>Tips:</strong> Be specific! The AI will analyze each document with your custom instruction.
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                        üìù Quick Templates
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="setCustomPrompt('privilege')" style="padding: 10px; font-size: 13px; background: #e7f0ff; color: #667eea;">
                            ‚öñÔ∏è Attorney-Client Privilege
                        </button>
                        <button onclick="setCustomPrompt('financial')" style="padding: 10px; font-size: 13px; background: #fff3cd; color: #FF9800;">
                            üí∞ Financial Fraud
                        </button>
                        <button onclick="setCustomPrompt('compliance')" style="padding: 10px; font-size: 13px; background: #f0f0f0; color: #666;">
                            üìã Compliance Issues
                        </button>
                        <button onclick="setCustomPrompt('contracts')" style="padding: 10px; font-size: 13px; background: #e7f0ff; color: #667eea;">
                            üìÑ Contract Terms
                        </button>
                        <button onclick="setCustomPrompt('rank')" style="padding: 10px; font-size: 13px; background: #dcfce7; color: #10b981;">
                            ‚ö° Quick Relevance Rank
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="createTagsCheckbox" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <div>
                            <strong style="color: #333;">üè∑Ô∏è Automatically create tags</strong>
                            <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                AI will create user tags like "Attorney-Client Privilege", "Financial Fraud", "Needs Review" based on findings
                            </div>
                        </div>
                    </label>
                </div>
                
                <div style="margin-bottom: 20px; background: #fff8dc; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <label style="display: flex; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="redactionModeCheckbox" style="margin-right: 10px; margin-top: 3px; width: 18px; height: 18px; cursor: pointer;" onchange="toggleRedactionPrompt()">
                        <div style="flex: 1;">
                            <strong style="color: #333;">üîí Redaction Mode</strong>
                            <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                AI will identify and redact sensitive information, creating redacted versions of documents
                            </div>
                            <div style="font-size: 12px; color: #667eea; margin-top: 6px; background: #f0f9ff; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #667eea;">
                                üí° <strong>Tip:</strong> When you check this box, the analysis prompt above will auto-fill. Just specify what to redact below!
                            </div>
                        </div>
                    </label>
                    
                    <div id="redactionPromptSection" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 13px;">
                            üéØ What should be redacted?
                        </label>
                        <textarea id="redactionPrompt" 
                                  placeholder="Example: Redact all Social Security Numbers, credit card numbers, attorney names, and client identities. Replace with [REDACTED - SSN], [REDACTED - NAME], etc."
                                  style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #dc3545; border-radius: 6px; font-size: 13px; font-family: inherit; line-height: 1.5;"></textarea>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            üí° Be specific! The AI will identify and redact matching content, showing you before/after versions.
                        </div>
                    </div>
                </div>
                
                <div id="customAIProgress" style="display: none; background: #e7f0ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">üöÄ Analysis in Progress...</h4>
                    <div style="background: rgba(255,255,255,0.5); height: 10px; border-radius: 5px; overflow: hidden; margin: 10px 0;">
                        <div id="customAIProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="customAIProgressText" style="font-size: 13px; color: #666; margin-bottom: 5px;">Starting...</div>
                    <div id="customAICurrentDoc" style="font-size: 12px; color: #888; font-style: italic;"></div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeCustomAIModal()" style="background: #e1e8ed; color: #666;">
                        Cancel
                    </button>
                    <button onclick="startCustomAIAnalysis()" id="customAIStartBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üöÄ Start Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDocuments = [];
        let currentDocumentForTag = null;

        // Available tags (loaded from server)
        let availableTags = [];

        // Cost tracking
        let costData = {
            totalCost: 0,
            embeddingsCost: 0,
            aiAnalysisCost: 0,
            documentsWithEmbeddings: 0,
            documentsAnalyzed: 0
        };

        // Load statistics and perform initial search on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadAIStats();
            loadAvailableTags();
            loadCostTracking();
            performSearch();
        });

        async function loadCostTracking() {
            try {
                // Get counts from database
                const [statsResponse, aiStatsResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/ai-stats')
                ]);
                
                const statsData = await statsResponse.json();
                const aiStatsData = await aiStatsResponse.json();
                
                if (statsData.success && aiStatsData.success) {
                    const totalDocs = statsData.stats.total_documents;
                    const analyzedDocs = aiStatsData.stats.analyzed_documents;
                    
                    // Calculate costs
                    // Embeddings: $0.0001 per document (assuming all docs have embeddings)
                    const embeddingsCost = totalDocs * 0.0001;
                    
                    // AI Analysis: $0.10 per document
                    const aiAnalysisCost = analyzedDocs * 0.10;
                    
                    const totalCost = embeddingsCost + aiAnalysisCost;
                    
                    // Update global cost data
                    costData = {
                        totalCost: totalCost,
                        embeddingsCost: embeddingsCost,
                        aiAnalysisCost: aiAnalysisCost,
                        documentsWithEmbeddings: totalDocs,
                        documentsAnalyzed: analyzedDocs
                    };
                    
                    // Update display
                    document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
                    
                    // Change color based on cost
                    const tracker = document.getElementById('costTracker');
                    if (totalCost > 100) {
                        tracker.style.background = 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)';
                    } else if (totalCost > 10) {
                        tracker.style.background = 'linear-gradient(135deg, #FFC107 0%, #FF9800 100%)';
                    }
                }
            } catch (error) {
                console.error('Failed to load cost tracking:', error);
            }
        }

        function showCostBreakdown() {
            const modal = document.getElementById('costModal');
            const content = document.getElementById('costBreakdownContent');
            
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üíµ Total Spent</h3>
                    <div style="font-size: 48px; font-weight: bold; color: #4CAF50;">
                        $${costData.totalCost.toFixed(2)}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: #e7f0ff; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">üìä Vector Embeddings</div>
                        <div style="font-size: 32px; font-weight: 600; color: #667eea; margin-bottom: 5px;">
                            $${costData.embeddingsCost.toFixed(4)}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ${costData.documentsWithEmbeddings} documents √ó $0.0001
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; border-left: 4px solid #FFC107;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ü§ñ AI Analysis</div>
                        <div style="font-size: 32px; font-weight: 600; color: #FF9800; margin-bottom: 5px;">
                            $${costData.aiAnalysisCost.toFixed(2)}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ${costData.documentsAnalyzed} documents √ó $0.10
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">üìà Cost Breakdown</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #e1e8ed;">
                            <td style="padding: 10px; font-weight: 600;">Service</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">Usage</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">Rate</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">Cost</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e1e8ed;">
                            <td style="padding: 10px;">OpenAI Embeddings</td>
                            <td style="padding: 10px; text-align: right;">${costData.documentsWithEmbeddings} docs</td>
                            <td style="padding: 10px; text-align: right;">$0.0001/doc</td>
                            <td style="padding: 10px; text-align: right; color: #4CAF50; font-weight: 600;">$${costData.embeddingsCost.toFixed(4)}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e1e8ed;">
                            <td style="padding: 10px;">Claude AI Analysis</td>
                            <td style="padding: 10px; text-align: right;">${costData.documentsAnalyzed} docs</td>
                            <td style="padding: 10px; text-align: right;">$0.10/doc</td>
                            <td style="padding: 10px; text-align: right; color: #FF9800; font-weight: 600;">$${costData.aiAnalysisCost.toFixed(2)}</td>
                        </tr>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td colspan="3" style="padding: 10px;">Total</td>
                            <td style="padding: 10px; text-align: right; color: #667eea; font-size: 18px;">$${costData.totalCost.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
                
                <div style="background: #e7f0ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <strong>üí° Cost Optimization Tips:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Embeddings are very cheap (~$0.0001/doc)</li>
                        <li>AI analysis is the main cost (~$0.10/doc)</li>
                        <li>Only analyze documents that need AI review</li>
                        <li>Use filters to reduce unnecessary analysis</li>
                        <li>Batch process documents for better efficiency</li>
                    </ul>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeCostModal() {
            document.getElementById('costModal').style.display = 'none';
        }

        // Custom AI Analysis Functions
        function showCustomAIPanel() {
            const modal = document.getElementById('customAIModal');
            const docCount = currentDocuments.length;
            const estimatedCost = docCount * 0.10;
            
            if (docCount === 0) {
                alert('‚ö†Ô∏è No documents selected. Please perform a search first.');
                return;
            }
            
            document.getElementById('customAIDocCount').textContent = docCount;
            document.getElementById('customAICost').textContent = `$${estimatedCost.toFixed(2)}`;
            document.getElementById('customAIProgress').style.display = 'none';
            document.getElementById('customAIPrompt').value = '';
            
            modal.style.display = 'block';
        }

        function closeCustomAIModal() {
            document.getElementById('customAIModal').style.display = 'none';
        }
        
        function toggleRedactionPrompt() {
            const checkbox = document.getElementById('redactionModeCheckbox');
            const section = document.getElementById('redactionPromptSection');
            const mainPrompt = document.getElementById('customAIPrompt');
            
            if (checkbox.checked) {
                section.style.display = 'block';
                // Auto-fill main prompt for redaction-only mode
                if (!mainPrompt.value || mainPrompt.value.trim() === '') {
                    mainPrompt.value = 'Review these documents and identify sensitive information that needs redaction.';
                    mainPrompt.style.background = '#f0f9ff';
                    mainPrompt.style.borderLeft = '3px solid #667eea';
                }
            } else {
                section.style.display = 'none';
                // Clear auto-filled prompt if it's the default redaction one
                if (mainPrompt.value === 'Review these documents and identify sensitive information that needs redaction.') {
                    mainPrompt.value = '';
                    mainPrompt.style.background = 'white';
                    mainPrompt.style.borderLeft = 'none';
                }
            }
        }

        const promptTemplates = {
            privilege: `Analyze this document for attorney-client privilege. Look for:
- Communications between attorneys and clients
- Legal advice or strategy discussions
- Work product or case preparation materials
- Privileged or confidential markings
- Attorney names or law firm mentions

Classify as "Privileged" if any indicators are found, otherwise "Not Privileged".`,
            
            financial: `Analyze this document for potential financial fraud indicators. Look for:
- Unusual financial transactions or patterns
- Hidden accounts or off-book entries
- Inconsistencies in financial reporting
- Suspicious transfers or payments
- Signs of embezzlement or misappropriation

Flag any red flags or concerning financial activity.`,
            
            compliance: `Analyze this document for compliance and regulatory issues. Look for:
- Violations of policies or regulations
- Non-compliance with industry standards
- Potential legal or ethical violations
- Risk management concerns
- Regulatory reporting issues

Identify any compliance risks or violations.`,
            
            contracts: `Analyze this document for key contract terms and obligations. Look for:
- Payment terms and amounts
- Delivery dates and deadlines
- Warranties and representations
- Termination clauses
- Liability and indemnification
- Non-compete or confidentiality provisions

Extract and summarize all important contractual terms.`,
            
            rank: `Rate this document's potential relevance for legal review on a scale of 0-100.
Consider: importance of content, key parties involved, legal significance, potential evidence value.
Focus on: providing just a relevance score and brief 1-sentence reason.`
        };

        function setCustomPrompt(templateName) {
            document.getElementById('customAIPrompt').value = promptTemplates[templateName];
        }

        async function startCustomAIAnalysis() {
            const prompt = document.getElementById('customAIPrompt').value.trim();
            const createTags = document.getElementById('createTagsCheckbox').checked;
            const redactionMode = document.getElementById('redactionModeCheckbox').checked;
            const redactionPrompt = document.getElementById('redactionPrompt').value.trim();
            
            if (!prompt) {
                alert('‚ö†Ô∏è Please enter an analysis instruction.');
                return;
            }
            
            if (redactionMode && !redactionPrompt) {
                alert('‚ö†Ô∏è Please specify what should be redacted.');
                return;
            }
            
            let confirmMsg = `This will analyze ${currentDocuments.length} documents with your custom instruction.\n\nEstimated cost: $${(currentDocuments.length * 0.12).toFixed(2)}`;
            if (createTags) {
                confirmMsg += '\n\nüè∑Ô∏è Tags will be automatically created based on findings.';
            }
            if (redactionMode) {
                confirmMsg += '\n\nüîí Redacted versions will be created based on your redaction instructions.';
            }
            confirmMsg += '\n\nContinue?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Show progress
            document.getElementById('customAIProgress').style.display = 'block';
            document.getElementById('customAIStartBtn').disabled = true;
            document.getElementById('customAIStartBtn').textContent = '‚è≥ Processing...';
            
            // Get document IDs
            const documentIds = currentDocuments.map(d => d.document_id);
            
            try {
                const response = await fetch('/api/custom-ai-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        document_ids: documentIds,
                        custom_prompt: prompt,
                        create_tags: createTags,
                        redaction_mode: redactionMode,
                        redaction_prompt: redactionPrompt
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Start polling for progress
                    pollCustomAIProgress(data.job_id || 'default', documentIds.length);
                } else {
                    alert('‚ùå Failed to start analysis: ' + data.error);
                    document.getElementById('customAIProgress').style.display = 'none';
                    document.getElementById('customAIStartBtn').disabled = false;
                    document.getElementById('customAIStartBtn').textContent = 'üöÄ Start Analysis';
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                document.getElementById('customAIProgress').style.display = 'none';
                document.getElementById('customAIStartBtn').disabled = false;
                document.getElementById('customAIStartBtn').textContent = 'üöÄ Start Analysis';
            }
        }

        async function pollCustomAIProgress(jobId, totalDocs) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/custom-ai-progress/${jobId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const progress = (data.processed / totalDocs) * 100;
                        document.getElementById('customAIProgressBar').style.width = progress + '%';
                        
                        // Show which document is being processed
                        let statusText = `Processed ${data.processed} of ${totalDocs} documents (${Math.round(progress)}%)`;
                        document.getElementById('customAIProgressText').textContent = statusText;
                        
                        // Show current document being analyzed
                        const currentDocDiv = document.getElementById('customAICurrentDoc');
                        if (data.current_subject && !data.completed) {
                            currentDocDiv.textContent = `üìÑ Analyzing: ${data.current_subject.substring(0, 80)}${data.current_subject.length > 80 ? '...' : ''}`;
                        } else if (data.completed) {
                            currentDocDiv.textContent = '';
                        } else {
                            currentDocDiv.textContent = data.processed > 0 ? '‚è≥ Processing next document...' : 'üöÄ Starting analysis...';
                        }
                        
                        if (data.completed) {
                            clearInterval(interval);
                            document.getElementById('customAIProgressText').textContent = 
                                `‚úÖ Complete! Analyzed ${totalDocs} documents.`;
                            document.getElementById('customAICurrentDoc').textContent = 'All documents have been analyzed successfully!';
                            
                            setTimeout(() => {
                                showResultsSummary(data.results);
                                closeCustomAIModal();
                                
                                // Show redacted documents if redaction mode was enabled
                                if (data.redaction_mode && data.redactions && data.redactions.length > 0) {
                                    setTimeout(() => {
                                        showRedactedDocuments(data.redactions);
                                    }, 500);
                                }
                                
                                performSearch(); // Refresh to show new results
                            }, 1500);
                        }
                    }
                } catch (error) {
                    console.error('Progress polling error:', error);
                }
            }, 500); // Poll every 500ms for more responsive updates
        }

        function showResultsSummary(results) {
            if (!results || results.length === 0) {
                return;
            }
            
            // Calculate summary stats
            const highRelevance = results.filter(r => r.relevance >= 70).length;
            const mediumRelevance = results.filter(r => r.relevance >= 40 && r.relevance < 70).length;
            const lowRelevance = results.filter(r => r.relevance < 40).length;
            
            const highPrivilege = results.filter(r => r.privilege_risk >= 70).length;
            const mediumPrivilege = results.filter(r => r.privilege_risk >= 40 && r.privilege_risk < 70).length;
            const lowPrivilege = results.filter(r => r.privilege_risk < 40).length;
            
            let html = `
                <div style="background: #e7f0ff; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px;">üìä Relevance Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #10b981;">${highRelevance}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">High Relevance (70+)</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #f59e0b;">${mediumRelevance}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">Medium Relevance (40-69)</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #94a3b8;">${lowRelevance}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">Low Relevance (<40)</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px;">‚öñÔ∏è Attorney-Client Privilege Risk</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #dc3545;">
                            <div style="font-size: 32px; font-weight: bold; color: #dc3545;">${highPrivilege}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">HIGH Risk (70+)</div>
                            <div style="font-size: 11px; color: #dc3545; margin-top: 5px; font-weight: 600;">‚ö†Ô∏è Likely Privileged</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 32px; font-weight: bold; color: #f59e0b;">${mediumPrivilege}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">MEDIUM Risk (40-69)</div>
                            <div style="font-size: 11px; color: #f59e0b; margin-top: 5px; font-weight: 600;">‚ö†Ô∏è Review Required</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #10b981;">
                            <div style="font-size: 32px; font-weight: bold; color: #10b981;">${lowPrivilege}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">LOW Risk (<40)</div>
                            <div style="font-size: 11px; color: #10b981; margin-top: 5px; font-weight: 600;">‚úì Likely Not Privileged</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">üìÑ Document Results</h3>
            `;
            
            // Sort by relevance (high to low)
            results.sort((a, b) => b.relevance - a.relevance);
            
            results.forEach(result => {
                const relevanceColor = result.relevance >= 70 ? '#10b981' : 
                                      result.relevance >= 40 ? '#f59e0b' : '#94a3b8';
                
                const classificationBadge = result.classification === 'relevant' ? 
                    '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">‚úì RELEVANT</span>' :
                    result.classification === 'not-relevant' ?
                    '<span style="background: #94a3b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">‚úó NOT RELEVANT</span>' :
                    '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">‚ö† NEEDS REVIEW</span>';
                
                const privilegeColor = result.privilege_risk >= 70 ? '#dc3545' : 
                                      result.privilege_risk >= 40 ? '#f59e0b' : '#10b981';
                const privilegeLevel = result.privilege_risk >= 70 ? 'HIGH' : 
                                      result.privilege_risk >= 40 ? 'MEDIUM' : 'LOW';
                
                html += `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         onclick="openDocument('${result.document_id}')"
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='#667eea';"
                         onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb';">
                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                            <div style="flex-shrink: 0; display: flex; gap: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: ${relevanceColor};">
                                        ${result.relevance}
                                    </div>
                                    <div style="font-size: 10px; color: #666;">Relevance</div>
                                </div>
                                <div style="text-align: center; border-left: 2px solid #e5e7eb; padding-left: 10px;">
                                    <div style="font-size: 24px; font-weight: bold; color: ${privilegeColor};">
                                        ${result.privilege_risk}
                                    </div>
                                    <div style="font-size: 10px; color: #666;">Privilege</div>
                                </div>
                            </div>
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                                    <span>${result.subject || 'No Subject'}</span>
                                    ${classificationBadge}
                                    <span style="background: ${privilegeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                        ‚öñÔ∏è ${privilegeLevel} PRIVILEGE RISK
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: #666; line-height: 1.5;">
                                    ${result.key_findings || 'Analysis completed'}
                                </div>
                                <div style="font-size: 12px; color: #667eea; margin-top: 8px;">
                                    üëÅÔ∏è Click to view full document
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; color: #666; font-size: 13px;">
                    üí° The search results below have been updated with these AI insights!
                </div>
            `;
            
            document.getElementById('resultsSummaryContent').innerHTML = html;
            document.getElementById('resultsSummaryModal').style.display = 'flex';
        }
        
        function closeResultsSummary() {
            document.getElementById('resultsSummaryModal').style.display = 'none';
        }
        
        let currentRedactions = [];
        let revealRedactions = false;
        
        function showRedactedDocuments(redactions) {
            if (!redactions || redactions.length === 0) {
                return;
            }
            
            currentRedactions = redactions;
            revealRedactions = false;
            
            let html = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                    <strong>üîí Redacted: ${redactions.length} document(s)</strong>
                    <div style="font-size: 13px; color: #666; margin-top: 8px;">
                        Redacted versions look like official redacted documents. Hover over black bars to see original text, or click "Reveal All" to toggle.
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                    <button id="toggleRedactionsBtn" onclick="toggleRevealRedactions()" style="background: #667eea; color: white; padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer;">
                        üëÅÔ∏è Reveal All Redactions
                    </button>
                    <span style="font-size: 13px; color: #666;">
                        üí° Hover over any <span style="background: black; color: black; padding: 2px 6px;">‚ñà‚ñà‚ñà‚ñà</span> redacted area to see original text
                    </span>
                </div>
            `;
            
            redactions.forEach((redaction, index) => {
                const redactedSubjectHtml = createVisuallyRedactedText(redaction.original_subject, redaction.redacted_subject, index, 'subject');
                const redactedBodyHtml = createVisuallyRedactedText(redaction.original_body, redaction.redacted_body, index, 'body');
                
                html += `
                    <div style="background: white; border: 2px solid #000; border-radius: 4px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="color: #000; margin: 0; font-family: 'Courier New', monospace;">
                                    REDACTED DOCUMENT ${String(index + 1).padStart(3, '0')}
                                </h3>
                                <div style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 3px; font-size: 11px; font-weight: 700; letter-spacing: 1px;">
                                    CONFIDENTIAL
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #fffef0; padding: 15px; border: 1px solid #000; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                                <strong>CLASSIFICATION:</strong>
                                <span>REDACTED PER PRIVACY ACT</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <strong>REDACTED ITEMS:</strong>
                                <span style="color: #666;">${escapeHtml(redaction.redaction_summary)}</span>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 2px solid #000; padding: 20px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8;">
                            <div style="margin-bottom: 25px;">
                                <div style="font-weight: bold; margin-bottom: 10px; text-decoration: underline;">SUBJECT:</div>
                                <div id="doc-${index}-subject" style="padding: 10px; background: #fafafa; border-left: 3px solid #000;">
                                    ${redactedSubjectHtml}
                                </div>
                            </div>
                            
                            <div>
                                <div style="font-weight: bold; margin-bottom: 10px; text-decoration: underline;">CONTENT:</div>
                                <div id="doc-${index}-body" style="padding: 15px; background: #fafafa; border-left: 3px solid #000; max-height: 500px; overflow-y: auto;">
                                    ${redactedBodyHtml}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 11px; color: #666; font-family: 'Courier New', monospace;">
                            DOCUMENT REDACTED: ${new Date().toLocaleString()} | REVIEW REQUIRED BEFORE DISTRIBUTION
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('redactedDocsContent').innerHTML = html;
            document.getElementById('redactedDocsModal').style.display = 'flex';
        }
        
        function createVisuallyRedactedText(originalText, redactedText, docIndex, section) {
            // Find all [REDACTED - XXX] patterns and replace with visual black bars
            const redactionRegex = /\[REDACTED - ([^\]]+)\]/g;
            
            let result = escapeHtml(redactedText);
            let matchIndex = 0;
            
            result = result.replace(redactionRegex, (match, redactionType) => {
                matchIndex++;
                const redactionId = `redact-${docIndex}-${section}-${matchIndex}`;
                
                // Extract the original text that was redacted
                // This is a simplified approach - in production, you'd track exact positions
                const redactionLength = Math.max(50, redactionType.length * 8);
                const blackBar = '‚ñà'.repeat(Math.ceil(redactionLength / 10));
                
                return `<span 
                    id="${redactionId}" 
                    class="redaction-bar" 
                    data-original="${escapeHtml(match)}"
                    title="Hover to reveal | Click 'Reveal All' button"
                    style="background: #000; color: #000; padding: 2px 6px; border-radius: 2px; cursor: help; position: relative; display: inline-block; user-select: none;"
                    onmouseenter="showRedactionTooltip(event, '${escapeHtml(redactionType)}')"
                    onmouseleave="hideRedactionTooltip()"
                >${blackBar}</span>`;
            });
            
            return result;
        }
        
        function showRedactionTooltip(event, redactionType) {
            if (revealRedactions) return;
            
            const tooltip = document.getElementById('redactionTooltip') || createTooltip();
            tooltip.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px; color: #dc3545;">üîí REDACTED</div>
                <div style="font-size: 12px; color: #666;">Type: ${redactionType}</div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">Click "Reveal All" to see original text</div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
        }
        
        function hideRedactionTooltip() {
            const tooltip = document.getElementById('redactionTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        function createTooltip() {
            const tooltip = document.createElement('div');
            tooltip.id = 'redactionTooltip';
            tooltip.style.cssText = `
                position: absolute;
                background: white;
                border: 2px solid #dc3545;
                border-radius: 6px;
                padding: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 250px;
                display: none;
                font-family: 'Courier New', monospace;
                font-size: 13px;
            `;
            document.body.appendChild(tooltip);
            return tooltip;
        }
        
        function toggleRevealRedactions() {
            revealRedactions = !revealRedactions;
            const btn = document.getElementById('toggleRedactionsBtn');
            const bars = document.querySelectorAll('.redaction-bar');
            
            if (revealRedactions) {
                btn.textContent = 'üîí Hide Redactions';
                btn.style.background = '#dc3545';
                bars.forEach(bar => {
                    bar.style.background = '#fff3cd';
                    bar.style.color = '#000';
                    bar.style.border = '2px solid #ffc107';
                    bar.style.fontFamily = 'inherit';
                    bar.textContent = ' ' + bar.getAttribute('data-original') + ' ';
                });
            } else {
                btn.textContent = 'üëÅÔ∏è Reveal All Redactions';
                btn.style.background = '#667eea';
                bars.forEach(bar => {
                    bar.style.background = '#000';
                    bar.style.color = '#000';
                    bar.style.border = 'none';
                    bar.style.fontFamily = "'Courier New', monospace";
                    const blackBar = '‚ñà'.repeat(Math.ceil(50 / 10));
                    bar.textContent = blackBar;
                });
            }
        }
        
        function closeRedactedDocs() {
            document.getElementById('redactedDocsModal').style.display = 'none';
            hideRedactionTooltip();
        }
        
        function exportRedactedDocs() {
            // Create a simple text export of redacted documents
            let exportText = "REDACTED DOCUMENTS\n";
            exportText += "=".repeat(80) + "\n";
            exportText += "Generated: " + new Date().toLocaleString() + "\n";
            exportText += "=".repeat(80) + "\n\n";
            
            currentRedactions.forEach((redaction, index) => {
                exportText += `DOCUMENT ${String(index + 1).padStart(3, '0')}\n`;
                exportText += "-".repeat(80) + "\n";
                exportText += `SUBJECT: ${redaction.redacted_subject}\n\n`;
                exportText += `CONTENT:\n${redaction.redacted_body}\n`;
                exportText += "\n" + "=".repeat(80) + "\n\n";
            });
            
            // Download as text file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `redacted_documents_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Redacted documents exported successfully!');
        }

        async function loadAvailableTags() {
            try {
                const response = await fetch('/api/tags/all');
                const data = await response.json();
                
                if (data.success) {
                    availableTags = data.tags.map(t => t.tag_name);
                    
                    // Populate tag filter dropdown
                    const tagSelect = document.getElementById('searchTag');
                    tagSelect.innerHTML = '<option value="">All Tags</option>';
                    data.tags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.tag_name;
                        option.textContent = `üè∑Ô∏è ${tag.tag_name} (${tag.count})`;
                        tagSelect.appendChild(option);
                    });
                    
                    // Update quick tag menu with popular tags
                    updateQuickTagMenu();
                }
            } catch (error) {
                console.error('Failed to load tags:', error);
            }
        }

        function updateQuickTagMenu() {
            // Keep common tags always visible, add user's tags
            const commonTags = ['Important', 'Follow-up', 'Legal Review', 'Privileged', 'Hot', 'Not Relevant'];
            const userTags = availableTags.filter(t => !commonTags.includes(t)).slice(0, 5);
            
            // This could be expanded to show user's recent tags
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-documents').textContent = data.stats.total_documents.toLocaleString();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadAIStats() {
            try {
                const response = await fetch('/api/ai-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stat-analyzed').textContent = stats.analyzed_documents.toLocaleString();
                    document.getElementById('stat-pending').textContent = stats.pending_documents.toLocaleString();
                    document.getElementById('stat-hot').textContent = stats.high_priority_count.toLocaleString();
                }
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        }

        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const custodian = document.getElementById('searchCustodian').value.trim();
            const classification = document.getElementById('searchClassification').value;
            const selectedTag = document.getElementById('searchTag').value;
            const reviewStatus = document.getElementById('searchReviewStatus').value;
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            const fileCategory = document.getElementById('searchFileCategory').value;  // NEW
            const dataQuality = document.getElementById('searchDataQuality').value;    // NEW
            
            const searchButton = document.getElementById('searchButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            searchButton.disabled = true;
            searchButton.textContent = '‚è≥ Searching...';
            resultsContainer.innerHTML = '<div class="loading">Searching documents...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query,
                        custodian,
                        classification,
                        date_from: dateFrom,
                        date_to: dateTo,
                        file_category: fileCategory,  // NEW
                        data_quality: dataQuality,    // NEW
                        limit: 100
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentDocuments = data.documents;
                    
                    // Filter by tag if selected
                    if (selectedTag) {
                        currentDocuments = currentDocuments.filter(d => {
                            const tags = d.user_tags || [];
                            return tags.includes(selectedTag);
                        });
                    }
                    
                    // Filter by review status if needed
                    if (reviewStatus === 'reviewed') {
                        currentDocuments = currentDocuments.filter(d => d.is_reviewed === true);
                    } else if (reviewStatus === 'unreviewed') {
                        currentDocuments = currentDocuments.filter(d => !d.is_reviewed);
                    }
                    
                    applySorting();
                    resultsCount.textContent = `Found ${currentDocuments.length} document(s)`;
                } else {
                    resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon">‚ùå</div><p>Error: ${data.error}</p></div>`;
                    resultsCount.textContent = 'Search failed';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `<div class="no-results"><div class="no-results-icon">‚ùå</div><p>Error: ${error.message}</p></div>`;
                resultsCount.textContent = 'Search failed';
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'üîç Search Documents';
            }
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            const sorted = [...currentDocuments];
            
            switch(sortBy) {
                case 'user_relevance':
                    sorted.sort((a, b) => (b.user_relevance_score || b.ai_relevance || 0) - (a.user_relevance_score || a.ai_relevance || 0));
                    break;
                case 'ai_relevance':
                    sorted.sort((a, b) => (b.ai_relevance || 0) - (a.ai_relevance || 0));
                    break;
                case 'date_desc':
                    sorted.sort((a, b) => new Date(b.collected_at) - new Date(a.collected_at));
                    break;
                case 'date_asc':
                    sorted.sort((a, b) => new Date(a.collected_at) - new Date(b.collected_at));
                    break;
                case 'custodian':
                    sorted.sort((a, b) => (a.custodian_email || '').localeCompare(b.custodian_email || ''));
                    break;
            }
            
            displayResults(sorted);
        }

        function displayResults(documents) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (documents.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <p>No documents found matching your search</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = documents.map(doc => {
                const aiClass = doc.ai_classification || 'Pending';
                const userClass = doc.user_classification;
                const userRel = doc.user_relevance_score;
                const aiRel = doc.ai_relevance || 0;
                const tags = doc.user_tags || [];
                const isReviewed = doc.is_reviewed;
                
                let cardClass = '';
                if (userClass === 'Critical') cardClass = 'user-critical';
                else if (aiClass === 'Hot Document') cardClass = 'hot';
                else if (aiClass === 'Privileged') cardClass = 'privileged';
                
                if (isReviewed) cardClass += ' reviewed';
                
                return `
                    <div class="document-card ${cardClass}" onclick="viewDocument('${doc.document_id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                            <div style="padding-top: 3px;" onclick="event.stopPropagation();">
                                <input type="checkbox" 
                                       class="doc-checkbox" 
                                       data-doc-id="${doc.document_id}" 
                                       onchange="updateSelectionCount()"
                                       style="width: 20px; height: 20px; cursor: pointer; accent-color: #667eea;">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                                    ${escapeHtml(doc.subject || 'No Subject')}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 4px;">
                                    <strong>From:</strong> ${escapeHtml(doc.custodian_email || 'Unknown')}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    <strong>Date:</strong> ${formatDate(doc.collected_at)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="classifications">
                            <div class="classification-badge ai">
                                ü§ñ AI: ${aiClass} (${aiRel}/100)
                            </div>
                            ${userClass ? `
                                <div class="classification-badge user">
                                    üë§ YOU: ${userClass} (${userRel}/100)
                                </div>
                            ` : ''}
                        </div>
                        
                        ${tags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${tags.map(tag => `<span class="tag user-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${doc.ai_summary ? `
                            <div style="font-size: 14px; color: #555; line-height: 1.6; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e1e8ed; font-style: italic;">
                                üí° ${escapeHtml(doc.ai_summary)}
                            </div>
                        ` : ''}
                        
                        <div class="document-actions" onclick="event.stopPropagation();">
                            <button class="action-btn tag-btn" onclick="showTagMenu('${doc.document_id}', event)">
                                üè∑Ô∏è Tag
                            </button>
                            <button class="action-btn review-btn" onclick="viewDocument('${doc.document_id}')">
                                üìù Review
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            if (typeof updateSelectionCount === 'function') {
                updateSelectionCount();
            }
        }

        function showTagMenu(documentId, event) {
            event.stopPropagation();
            const menu = document.getElementById('quickTagMenu');
            const rect = event.target.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.position = 'fixed';
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            
            currentDocumentForTag = documentId;
            document.getElementById('customTagInput').value = '';
        }

        async function quickTag(tagName) {
            if (!tagName || !currentDocumentForTag) return;
            
            tagName = tagName.trim();
            if (!tagName) return;
            
            try {
                const response = await fetch(`/api/document/${currentDocumentForTag}/tags`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tag_name: tagName})
                });
                
                const data = await response.json();
                if (data.success) {
                    // Reload available tags (updates dropdown)
                    await loadAvailableTags();
                    // Refresh search to show new tag
                    performSearch();
                }
            } catch (error) {
                console.error('Failed to add tag:', error);
            }
            
            document.getElementById('quickTagMenu').style.display = 'none';
            document.getElementById('customTagInput').value = '';
        }

        async function viewDocument(documentId) {
            const modal = document.getElementById('documentModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = '<div class="loading">Loading document...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`/api/document/${documentId}`);
                const data = await response.json();
                
                if (data.success) {
                    const doc = data.document;
                    const hasAI = doc.ai_analyzed_at !== null;
                    const bodyText = doc.body_text || doc.body || doc.original_text || '';
                    const hasRedaction = doc.redacted_body && doc.redacted_body.trim().length > 0;
                    const redactionTimestamp = doc.redaction_created_at ? new Date(doc.redaction_created_at).toLocaleString() : null;
                    const docKey = (doc.document_id || 'doc').replace(/[^a-zA-Z0-9_-]/g, '');
                    let redactionSection = '';

                    if (hasRedaction) {
                        const redactedSubjectHtml = createVisuallyRedactedText(
                            doc.subject || '',
                            doc.redacted_subject || doc.subject || '',
                            `${docKey}-modal`,
                            'subject'
                        );

                        const redactedBodyHtml = createVisuallyRedactedText(
                            bodyText,
                            doc.redacted_body,
                            `${docKey}-modal`,
                            'body'
                        );

                        redactionSection = `
                            <div style="margin-top: 25px; background: #fff8dc; padding: 20px; border-radius: 12px; border-left: 4px solid #dc3545;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <h3 style="margin: 0; color: #dc3545;">üîí Redacted View</h3>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <button onclick="toggleRevealRedactions()" style="background: #667eea; color: white; padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer;">
                                            üëÅÔ∏è Toggle Redactions
                                        </button>
                                        ${redactionTimestamp ? `<span style="font-size: 12px; color: #666;">Last updated: ${redactionTimestamp}</span>` : ''}
                                    </div>
                                </div>
                                <p style="font-size: 13px; color: #666; margin-top: 12px;">
                                    Hover over any <span style="background: black; color: black; padding: 2px 6px; border-radius: 2px;">‚ñà‚ñà‚ñà‚ñà‚ñà</span> bar to preview the hidden text, or click the toggle to reveal/hide all redactions at once.
                                </p>
                                ${doc.redaction_summary ? `
                                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 20px;">
                                        <strong>Summary of Redactions:</strong>
                                        <div style="margin-top: 8px; font-size: 13px; color: #444;">${escapeHtml(doc.redaction_summary)}</div>
                                    </div>
                                ` : ''}
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                    <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.05);">
                                        <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">üìù Original Subject</div>
                                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 13px;">${escapeHtml(doc.subject || '')}</div>
                                        <div style="font-size: 12px; font-weight: 600; color: #666; margin: 15px 0 8px;">üìÑ Original Body</div>
                                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; max-height: 260px; overflow-y: auto;">${escapeHtml(bodyText)}</div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px; border: 1px solid rgba(220,53,69,0.2);">
                                        <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin-bottom: 8px;">üîí Redacted Subject</div>
                                        <div style="background: #fff0f0; padding: 12px; border-radius: 6px; font-size: 13px;">${redactedSubjectHtml}</div>
                                        <div style="font-size: 12px; font-weight: 600; color: #dc3545; margin: 15px 0 8px;">üîí Redacted Body</div>
                                        <div style="background: #fff0f0; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; max-height: 260px; overflow-y: auto;">${redactedBodyHtml}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Get current user review
                    const reviewResponse = await fetch(`/api/document/${documentId}/review`);
                    const reviewData = await reviewResponse.json();
                    const review = reviewData.review || {};
                    
                    // Get tags
                    const tagsResponse = await fetch(`/api/document/${documentId}/tags`);
                    const tagsData = await tagsResponse.json();
                    const tags = tagsData.tags || [];
                    console.log('üìå Tags for document:', documentId, tags);
                    
                    modalContent.innerHTML = `
                        <h2>${escapeHtml(doc.subject || 'No Subject')}</h2>
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            <strong>Document ID:</strong> ${escapeHtml(doc.document_id)}<br>
                            <strong>From:</strong> ${escapeHtml(doc.custodian_email || 'Unknown')}<br>
                            <strong>Date:</strong> ${formatDate(doc.collected_at)}<br>
                            <strong>Source:</strong> ${escapeHtml(doc.source)}
                        </div>
                        
                        ${redactionSection}
                        
                        ${hasAI ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">ü§ñ AI Analysis</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Classification</div>
                                        <div style="font-size: 20px; font-weight: 600;">${doc.ai_classification}</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Relevance Score</div>
                                        <div style="font-size: 20px; font-weight: 600;">${doc.ai_relevance}/100</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Privilege Risk</div>
                                        <div style="font-size: 20px; font-weight: 600;">${doc.ai_privilege_risk}/100</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <strong>üìù AI Summary:</strong>
                                    <p style="margin-top: 10px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px;">
                                        ${escapeHtml(doc.ai_summary || 'N/A')}
                                    </p>
                                </div>
                                
                                ${doc.ai_topics && doc.ai_topics.length > 0 ? `
                                    <div style="margin-top: 15px;">
                                        <strong>üè∑Ô∏è Key Topics:</strong>
                                        <div style="margin-top: 10px;">
                                            ${doc.ai_topics.map(topic => `<span class="tag">${escapeHtml(topic)}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;"><p>‚è≥ AI analysis pending...</p></div>'}
                        
                        ${review.review_notes && review.review_notes.includes('Custom Analysis:') ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin: 20px 0; color: white;">
                                <h3 style="color: white; margin-bottom: 15px;">üéØ Custom AI Analysis Results</h3>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid white;">
                                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; line-height: 1.6;">${escapeHtml(review.review_notes)}</pre>
                                </div>
                                ${tags.length > 0 ? `
                                    <div style="margin-top: 15px;">
                                        <strong style="display: block; margin-bottom: 10px;">üè∑Ô∏è Auto-Generated Tags:</strong>
                                        <div>
                                            ${tags.map(t => `<span style="background: white; color: #667eea; padding: 6px 12px; border-radius: 6px; display: inline-block; margin: 4px; font-weight: 600;">${escapeHtml(t.tag_name)}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="review-panel">
                            <h3>Your Review</h3>
                            
                            <div class="review-section">
                                <label>Your Classification</label>
                                <select id="userClassification">
                                    <option value="">-- Select --</option>
                                    <option value="Critical" ${review.user_classification === 'Critical' ? 'selected' : ''}>üî¥ Critical</option>
                                    <option value="Important" ${review.user_classification === 'Important' ? 'selected' : ''}>üü† Important</option>
                                    <option value="Relevant" ${review.user_classification === 'Relevant' ? 'selected' : ''}>üü° Relevant</option>
                                    <option value="Routine" ${review.user_classification === 'Routine' ? 'selected' : ''}>üü¢ Routine</option>
                                    <option value="Not Relevant" ${review.user_classification === 'Not Relevant' ? 'selected' : ''}>‚ö™ Not Relevant</option>
                                </select>
                            </div>
                            
                            <div class="review-section">
                                <label>Your Relevance Score: <span id="userRelevanceValue">${review.user_relevance_score || 50}</span>/100</label>
                                <input type="range" id="userRelevanceScore" class="relevance-slider" 
                                       min="0" max="100" value="${review.user_relevance_score || 50}"
                                       oninput="document.getElementById('userRelevanceValue').textContent = this.value">
                            </div>
                            
                            <div class="review-section">
                                <label>Your Tags ${tags.length > 0 ? `(${tags.length})` : ''}</label>
                                <div style="margin-bottom: 10px; min-height: 30px;">
                                    ${tags.length > 0 ? tags.map(t => `
                                        <span class="tag removable" onclick="removeTag('${documentId}', '${escapeHtml(t.tag_name)}')">
                                            üè∑Ô∏è ${escapeHtml(t.tag_name)} <span style="color: #f5576c; margin-left: 5px;">√ó</span>
                                        </span>
                                    `).join('') : '<span style="color: #999; font-size: 13px;">No tags yet. Add tags to organize this document.</span>'}
                                </div>
                                <div class="tag-input">
                                    <input type="text" id="newTagInput" placeholder="Add a tag..." 
                                           onkeypress="if(event.key==='Enter') addTag('${documentId}')">
                                    <button onclick="addTag('${documentId}')">Add</button>
                                </div>
                            </div>
                            
                            <div class="review-section">
                                <label>Your Notes</label>
                                <textarea id="reviewNotes" placeholder="Add your review notes...">${escapeHtml(review.review_notes || '')}</textarea>
                            </div>
                            
                            <div class="review-section">
                                <div class="review-checkbox">
                                    <input type="checkbox" id="isReviewed" ${review.is_reviewed ? 'checked' : ''}>
                                    <label for="isReviewed">‚úì Mark as Reviewed</label>
                                </div>
                            </div>
                            
                            <button class="save-review-btn" onclick="saveReview('${documentId}')">
                                üíæ Save Review
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h3>üìÑ Document Content</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto; margin-top: 10px; border: 1px solid #e1e8ed;">
                                ${escapeHtml(bodyText || 'No body text')}
                            </div>
                        </div>
                    `;
                } else {
                    modalContent.innerHTML = `<p>Error loading document: ${data.error}</p>`;
                }
            } catch (error) {
                modalContent.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        async function saveReview(documentId) {
            const review = {
                user_classification: document.getElementById('userClassification').value || null,
                user_relevance_score: parseInt(document.getElementById('userRelevanceScore').value),
                is_reviewed: document.getElementById('isReviewed').checked,
                review_notes: document.getElementById('reviewNotes').value || null
            };
            
            try {
                const response = await fetch(`/api/document/${documentId}/review`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(review)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Review saved successfully!');
                    performSearch(); // Refresh to show updated review status
                }
            } catch (error) {
                alert('‚ùå Failed to save review: ' + error.message);
            }
        }

        async function addTag(documentId) {
            const tagName = document.getElementById('newTagInput').value.trim();
            if (!tagName) return;
            
            try {
                const response = await fetch(`/api/document/${documentId}/tags`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tag_name: tagName})
                });
                
                const data = await response.json();
                if (data.success) {
                    // Reload available tags to update dropdown
                    await loadAvailableTags();
                    // Refresh modal to show new tag
                    viewDocument(documentId);
                }
            } catch (error) {
                alert('Failed to add tag: ' + error.message);
            }
        }

        async function removeTag(documentId, tagName) {
            try {
                const response = await fetch(`/api/document/${documentId}/tags`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tag_name: tagName})
                });
                
                const data = await response.json();
                if (data.success) {
                    // Reload available tags to update dropdown
                    await loadAvailableTags();
                    // Refresh modal
                    viewDocument(documentId);
                }
            } catch (error) {
                alert('Failed to remove tag: ' + error.message);
            }
        }

        function exportResults() {
            if (currentDocuments.length === 0) {
                alert('No documents to export. Please perform a search first.');
                return;
            }
            
            const headers = ['Document ID', 'Subject', 'Custodian Email', 'Date', 'Source', 
                           'AI Classification', 'AI Relevance', 'User Classification', 'User Relevance', 
                           'Reviewed', 'Tags', 'AI Summary'];
            const rows = currentDocuments.map(doc => [
                doc.document_id,
                doc.subject || '',
                doc.custodian_email || '',
                doc.collected_at,
                doc.source,
                doc.ai_classification || '',
                doc.ai_relevance || '',
                doc.user_classification || '',
                doc.user_relevance_score || '',
                doc.is_reviewed ? 'Yes' : 'No',
                (doc.user_tags || []).join('; '),
                (doc.ai_summary || '').replace(/"/g, '""')
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ediscovery_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closeModal() {
            document.getElementById('documentModal').style.display = 'none';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Allow Enter key to search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });

        // Close modal and tag menu when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('documentModal');
            if (e.target === modal) closeModal();
            
            const costModal = document.getElementById('costModal');
            if (e.target === costModal) closeCostModal();
            
            const tagMenu = document.getElementById('quickTagMenu');
            if (tagMenu.style.display !== 'none' && !tagMenu.contains(e.target)) {
                tagMenu.style.display = 'none';
            }
        });
    </script>
</body>
</html>

